---
title: bedbaser
author:
- name: J Wokaty
  affiliation: CUNY School of Public Health
  email: jennifer.wokaty@sph.cuny.edu
package: bedbaser
output: 
  BiocStyle::html_document
vignette: >
  %\VignetteIndexEntry{bedbaser}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}  
---

```{r library, include=FALSE}
library(bedbaser)
```

bedbaser is an R client for [BEDbase](https://bedbase.org), a platform for
genomic region data that allows users to search BED files and curate collections.
It provides convenience functions to interact with the
[BEDbase API](https://api.bedbase.org) and allows more direct interaction with
the API through `r Biocpkg("AnVIL")`'s `Service` class.
bedbaser also imports BED files into `GRanges` objects.

## Install bedbaser

Install bedbaser using `r CRANpkg("BiocManager")`.

```{r install, eval=FALSE}
if (!"BiocManager" %in% rownames(installed.packages()))
    install.packages("BiocManager")
BiocManager::install("bedbaser", dependencies=TRUE)
```

## Create a bedbaser client

bedbaser uses the `r Biocpkg("AnVIL")` Service class to create a `BEDbase`
client, which can be use to access the API directly.

```{r bedbase}
client <- BEDbase()
show(client)
```

End points can be accessed with `$` and their results can be retrieved
with `r CRANpkg("httr")`.

```{r count_bed_record_bed_count_get}
library(httr)
rsp <- client$get_example_bed_record_v1_bed_example_get()
example_bed <- content(rsp)
```

bedbaser includes convenience functions prefixed with *bb_* to facilitate
finding BEDs, exploring their metadata, and download files.

## Find a BED file or BEDset

Use `bb_list()` to browse available resources in BEDbase. `bb_list()`
displays the record identifiers and names of BED files and BEDsets.
Record identifiers can be used to access a specific resource.

```{r bb_list_beds}
bb_list_beds(client)

bb_list_bedsets(client)
```

### Examine metadata

Use `bb_metadata()` to learn more about a BED or BEDset associated with
a record identifier.

Note: Currently a list of lists, but maybe could be a better format?

```{r bb_metadata}
metadata <- bb_metadata(client, example_bed$id, "bed")

```

### Show BED files in BEDset

Use `bb_beds_in_bedset()` to display the record identifiers of BEDs in a
BEDset. 

```{r bb_beds_in_bedset, eval=FALSE}
# Need to fix
bb_beds_in_bedset(client, "excluderanges")
```

### Search for a BED file by keyword

Search for BED files by keywords:

```{r bb_search, eval=FALSE}
# Currently not working correctly
results <- bb_search(client, "hg13")
results
```

## Import a BED into a GRanges object

`bb_to_granges` creates a GRanges object from a BED record identifier. It uses 
`rtracklayer` to import the BED file. When column names are not known for BEDX+Y
formats, a name is given indicating its position in the BED file.

Note: Still in development, working for broadPeak, narrowPeak, and BEDX+0

```{r bb_to_granges}
rec_id1 <- "bbad85f21962bb8d972444f7f9a3a932"
bed1 <- bb_metadata(client, rec_id1, rec_type = "bed")
print(paste(bed1$name, "is in", bed1$bed_type, "format."))
obj1 <- bb_to_granges(client, rec_id1, file_type="bed", quietly = TRUE)
obj1

# The following imports a BED4+1. Since we don't know the last column, we take
# the column name and type from reading the table, which is V5.
bed2 <- bb_metadata(client, example_bed$id, rec_type = "bed")
print(paste(bed2$name, "is in", bed2$bed_type, "format."))
obj2 <- bb_to_granges(client, example_bed$id, file_type="bed", quietly = TRUE)
obj2
# This is the same as
# file_path <- "/home/meatbag/.cache/R/bedbaser/5611ae9d790f_04c46b96264ef40bca93f03b10345da5.bed"
# import.bed(file_path, extraCols = c(V5 = numeric))
```x`

## SessionInfo()

```{r sessionInfo}
sessionInfo()
```   
Notes: For metadata in R, maybe create a tibble from some reasonable level of untested data, then demo use of tidy::unnest_wider() / unnest_longer(),  GRanges as plyranges?

Can you specify the column names interactively? 
